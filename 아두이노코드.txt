#include <Servo.h>

Servo servo;

// 초음파1 핀
const int TRIG1 = 13;
const int ECHO1 = 12;

// 초음파2 핀
const int TRIG2 = 22;
const int ECHO2 = 24;

// 목표 구간
const float diff_LOW  = 115.3;  // mm
const float diff_HIGH = 128.5;  // mm

// 이동평균 창 크기
const int WINDOW = 5;

// d1, d2 이동평균용 버퍼
float d1Buf[WINDOW];
float d2Buf[WINDOW];
int d1Index = 0, d2Index = 0;
int d1Count = 0, d2Count = 0;

float readUltrasonicMM(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 20000);  // 타임아웃 20ms

  if (duration == 0) {
    return 9999.0;  // 측정 실패 시 큰 값
  }

  // 속도 ~343 m/s → 0.343 mm/µs
  // 편도라서 /2 → 0.1715 mm/µs
  float distance_mm = duration * 0.1715;
  return distance_mm;
}

void setup() {
  Serial.begin(115200);

  pinMode(TRIG1, OUTPUT);
  pinMode(ECHO1, INPUT);
  pinMode(TRIG2, OUTPUT);
  pinMode(ECHO2, INPUT);

  servo.attach(11);      // 서보 신호핀
  servo.write(90);       // 정지(연속회전 서보 기준)
}

void loop() {
  // ===== d1 최근 5개 이동평균 =====
  float d1_raw = readUltrasonicMM(TRIG1, ECHO1);
  d1Buf[d1Index] = d1_raw;
  d1Index = (d1Index + 1) % WINDOW;
  if (d1Count < WINDOW) d1Count++;

  float d1 = 0.0;
  for (int i = 0; i < d1Count; i++) {
    d1 += d1Buf[i];
  }
  d1 /= d1Count;
  // ==============================

  // ===== d2 최근 5개 이동평균 =====
  float d2_raw = readUltrasonicMM(TRIG2, ECHO2);
  d2Buf[d2Index] = d2_raw;
  d2Index = (d2Index + 1) % WINDOW;
  if (d2Count < WINDOW) d2Count++;

  float d2 = 0.0;
  for (int i = 0; i < d2Count; i++) {
    d2 += d2Buf[i];
  }
  d2 /= d2Count;
  // ==============================

  float diff = d1 - d2;

  Serial.print("d1(avg): ");
  Serial.print(d1);
  Serial.print("  d2(avg): ");
  Serial.print(d2);
  Serial.print("  diff: ");
  Serial.println(diff);

  if (diff > diff_HIGH) {
    // 너무 멀다 → 한쪽 방향으로 조금 이동
    servo.write(83);
    delay(300);
    servo.write(90);  // 정지
    Serial.println("sex");

  } else if (diff < diff_LOW) {
    // 너무 가깝다 → 반대 방향으로 조금 이동
    servo.write(100);
    delay(300);
    servo.write(90);  // 정지
    Serial.println("porn");

  } else {  // diff_LOW <= diff <= diff_HIGH
    // 범위 안이면 정지 유지
    servo.write(90);
    Serial.println("ssibal");
    delay(5000);
  }

  delay(500);  // 측정 주기 약간 여유
}
