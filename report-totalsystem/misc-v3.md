# 기타(하드웨어·운영) 기술 보고서 v3

## 1. 역할과 범위
- 이 영역은 소프트웨어 밖의 실제 장치·운영 스크립트를 다룹니다.
  - 아두이노 스케치(`total_system/total_system.ino`): XY 스테이지와 무선 충전부를 제어하는 펌웨어.
  - 운영 스크립트(`run.ps1` 등): 개발 환경에서 백엔드·프런트·워커를 한 번에 실행하기 위한 도구.

## 2. 아두이노 제어 로직(total_system.ino)
### 2.1 하드웨어 구성
- 마이크로컨트롤러: Arduino 보드(예: Uno 계열).
- 센서/액추에이터:
  - 서보 모터 2개: X축, Y축 이동(핀 9, 10).
  - 초음파 센서 3개:
    - 좌측(X 측거리 측정), 우측(보조), 전면(Y 거리 측정).
  - 전류 센서(A0): 충전 중 흐르는 전류를 읽어 충전량 추정.
  - RGB LED (핀 11, 12, 13): 상태 표시(예: 승인, 충전 중, 완료).
  - I2C LCD: 현재 상태·안내 메시지 표시.

### 2.2 상태 머신 구조
- `State` 열거형:
  - `S00_WAIT_SIGNAL`: 차량 도착 및 시작 신호 대기 (시리얼 입력).
  - `S01_WAIT_INPUT`: 목표 충전량(Q_target_mAh) 입력 대기.
  - `S1_APPROVING`: 승인 대기(예: 10초 동안 확인 시간).
  - `S2_APPROVED`: 승인 완료 상태(사용자에게 정렬 시작 안내).
  - `S3_ALIGNING`: 초음파 센서 값을 이용해 패드와 차량 코일을 정렬.
  - `S4_CHARGING`: 전류를 측정하며 목표 충전량까지 충전.
  - `S5_COMPLETED`: 충전 완료, 원위치 복귀 후 초기 상태로 리셋.

### 2.3 동작 상세
1) `S00_WAIT_SIGNAL` – 신호 대기
   - LCD에 “WAITING SIGNAL..” 표시.
   - 시리얼 버퍼를 비운 뒤, 새 입력이 감지되면 “차량 인식”으로 간주하고 다음 상태로 전환합니다.
   - 실제 운용에서는 카메라 워커가 시리얼 포트에 START 메시지를 보내어 이 상태를 깨웁니다.

2) `S01_WAIT_INPUT` – 목표 충전량 입력
   - LCD에 “VEHICLE DETECTED / Input Target Q” 표시.
   - 시리얼에서 숫자 입력을 읽어 `Q_target_mAh`에 저장(0이면 디버그 모드: 시간 기반 충전).

3) `S1_APPROVING` – 승인 대기
   - 빨간 LED를 켜고, 10초 동안 승인 대기(예: 사람이 차량 위치를 확인하거나 안전 점검).
   - LCD에 남은 초를 표시하며 간단한 애니메이션(점점점)을 반복.
   - 10초가 지나면 다음 상태로 전환.

4) `S2_APPROVED` – 승인 완료
   - 초록 LED를 켜고 “APPROVED! Ready to Align” 메시지를 표시.
   - 짧은 지연 후 정렬 단계로 이동.

5) `S3_ALIGNING` – XY 정렬
   - X축:
     - 좌측 초음파 센서로 거리(`distL`) 측정.
     - 선형식 `thetaX = AX * distL + BX`로 거리 → 각도 변환.
     - `SERVO_MIN`~`SERVO_MAX` 범위로 제한 후 X 서보에 적용.
   - Y축:
     - 전면 초음파 센서로 거리(`distF`) 측정.
     - 선형식 `thetaY = AY * distF + BY` 적용, 동일한 범위 제한 후 Y 서보에 적용.
   - 정렬 완료 후 LCD에 “ALIGN COMPLETE” 표시, 5초 대기 후 충전 단계로 이동.

6) `S4_CHARGING` – 충전
   - 주황 LED를 켜고, 루프마다 전류 센서 값을 읽습니다.
   - 전류(Ampere)와 시간(delta t)을 곱해 누적 전하량(As)을 계산하고, 이를 mAh로 변환(`Q_accum_mAh`).
   - LCD에는 두 화면을 번갈아 표시:
     - 화면 1: “CHARGING... / [DEBUG MODE] 또는 Do Not Touch”.
     - 화면 2: “Tgt: xxxmA / Cur: yyymA”.
   - 종료 조건:
     - 목표 충전량이 0이면(디버그 모드) 일정 시간(예: 10초) 후 종료.
     - 목표 충전량이 양수면, `Q_accum_mAh >= Q_target_mAh`일 때 종료.
   - 종료 시 주황 LED를 끄고 완료 상태로 전환.

7) `S5_COMPLETED` – 완료 및 복귀
   - 초록 LED를 켜고 “CHARGE COMPLETE! Returning...” 메시지를 표시.
   - 일정 시간 후 X, Y 서보를 홈 위치로 돌려 놓고, 잠시 기다린 뒤 `resetSystem()`을 호출해 처음 상태로 되돌립니다.

## 3. 운영 스크립트(run.ps1 등)
### 3.1 run.ps1 역할
- PowerShell 스크립트로, 개발 환경에서 필요한 프로세스를 한 번에 실행합니다.
  - Python 가상환경 확인 및 선택.
  - 백엔드 uvicorn 서버 실행.
  - 두 프런트(user-front, admin-front) `npm run dev -- --host` 실행.
  - 환경변수 자동 설정:
    - `AUTO_SEED_SESSIONS=1` (기본 세션 자동 생성).
    - `CORS_ORIGINS`: 로컬 IP/포트를 기반으로 허용 도메인 목록 생성.
    - `VITE_API_BASE`: 첫 번째 로컬 IP를 사용해 `http://<ip>:8000`으로 설정.
    - `OPENAI_API_KEY`: 없다면 `openai-key.txt`에서 읽기.
    - `PLATE_SERVICE_URL`: 기본 `/api/license-plates`.
  - 옵션:
    - `RUN_CAMERA_WORKER=1`이면 카메라 워커(`camera-capture/main.py`)도 함께 실행.
    - `CAMERA_WORKER_ARGS`로 워커에 전달할 인자 정의.

### 3.2 기타 스크립트
- `start-manual-capture.ps1/.bat`
  - Firebase를 거치지 않고 로컬에서 한 번만 카메라 워커를 실행해 사진을 찍고, 인식/매칭 결과를 확인하는 용도입니다.
  - 마지막 리포트 JSON을 읽어, 매칭 결과가 `match=true`면 `start-arduino-workflow.ps1`를 실행해 아두이노를 구동합니다.
- `send-serial-trigger.ps1/.bat`
  - 특정 시리얼 포트로 간단한 메시지를 보내 아두이노를 수동으로 시작시킬 수 있습니다(테스트용).

## 4. 강점과 한계
### 4.1 강점
- 하드웨어 상태를 LCD·LED·시리얼 로그로 동시에 표현해 디버깅이 용이합니다.
- 선형 캘리브레이션 상수(AX/BX, AY/BY)를 코드 상단에서 쉽게 수정할 수 있어, 현장 보정에 유연합니다.
- 운영 스크립트가 개발용 기본값을 자동 설정해, 새 환경에서도 빠르게 “전체 시스템”을 띄울 수 있습니다.

### 4.2 한계
- 아두이노 코드는 단일 루프 기반이라, 예외 상황(센서 오작동 등)에 대한 분기와 복구 로직이 제한적입니다.
- 센서 노이즈나 설치 환경에 따라 거리 측정값이 흔들릴 수 있고, 이에 대한 필터링이 단순합니다.
- run.ps1는 개발용 dev 서버에 맞춰져 있어, 실제 배포 환경(HTTPS, 리버스 프록시 등)에 대한 설정이 별도로 필요합니다.

## 5. 향후 개선 방향
- 하드웨어:
  - 초음파 센서 값에 대한 이동 평균/필터링 적용.
  - 비상 정지 스위치, 과전류 감지 등 안전 인터락 추가.
  - 정렬 실패/센서 오류 시 재시도 및 오류 코드 표시.
- 운영:
  - 프로덕션용 Docker Compose/서비스 유닛(systemd) 작성.
  - 로그를 중앙 서버(예: ELK, Loki)에 전송하고, 알림 시스템과 연동.
  - 개발·운영 프로필을 분리해, 같은 코드로도 다른 설정으로 실행 가능하게 구성.

